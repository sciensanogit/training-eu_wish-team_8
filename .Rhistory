fontsize(part = "header",size = 10) %>%
autofit() %>% theme_vanilla()
cat("- Success : tables saved \n")
df_nation <- read.table(file = "./data_example/Belgium_export-nation.csv", sep = ";", dec = ".", header = T)
pkgs <- c("dplyr", "ggplot2", "flextable", "quarto")
install.packages(setdiff(pkgs, rownames(installed.packages())))
invisible(lapply(pkgs, FUN = library, character.only = TRUE))
# load data
df_nation <- read.table(file = "./data_example/Belgium_export-nation.csv", sep = ";", dec = ".", header = T)
df_nation <- read.table(file = "./data_example/Belgium_export-nation.csv", sep = ";", dec = ".", header = T)
produce tables
df_nation <- read.table(file = "./data_example/Belgium_export-nation.csv", sep = ";", dec = ".", header = T)
setwd("~/training-eu_wish-team_8")
pkgs <- c("dplyr", "ggplot2", "flextable", "quarto")
install.packages(setdiff(pkgs, rownames(installed.packages())))
invisible(lapply(pkgs, FUN = library, character.only = TRUE))
df_nation <- read.table(file = "./data_example/Belgium_export-nation.csv", sep = ";", dec = ".", header = T)
get(wd)
getwd()
df_nation <- read.table(file = "./data_example/Belgium_export-nation.csv", sep = ";", dec = ".", header = T)
library(readr)
Belgium_export_nation <- read_delim("Belgium_export-nation.csv",
delim = ";", escape_double = FALSE, trim_ws = TRUE)
View(Belgium_export_nation)
df_nation <- read.table(file = "./data_example/Belgium_export-nation.csv", sep = ";", dec = ".", header = T)
# load data
df_nation <- read.table(file = "Belgium_export-nation.csv", sep = ";", dec = ".", header = T)
pkgs <- c("dplyr", "ggplot2", "flextable", "quarto")
# install packages
install.packages(setdiff(pkgs, rownames(installed.packages())))
invisible(lapply(pkgs, FUN = library, character.only = TRUE))
df_nation <- read.table(file = "Belgium_export-nation.csv", sep = ";", dec = ".", header = T)
tbl_nation <- df_nation %>%
select(siteName, date, value_pmmv) %>%
arrange(desc(date)) %>%
slice_head(n = 10) %>%
flextable() %>%
fontsize(part = "body",size = 10) %>%
fontsize(part = "header",size = 10) %>%
autofit() %>% theme_vanilla()
tbl_nation
cat("- Success : tables saved \n")
ibrary(knitr)
## display understandable headers, nice units, nice digits
library(knitr)
library(knitr)
install.packages("kableExtra")
write.csv(mondays, "data.csv", row.names = FALSE)  # Raw export
# display msg
cat("- Success : tables saved \n")
library(dplyr)
mondays <- Belgium_export_nation %>%
mutate(datetime = as.POSIXct(date)) %>%
filter(weekdays(datetime) == "Monday")
View(mondays)
library(knitr)
install.packages("kableExtra")
install.packages("kableExtra")
write.csv(mondays, "data.csv", row.names = FALSE)  # Raw export
# display msg
cat("- Success : tables saved \n")
title: 'Wastewater-based surveillance report'
#| label: load packages and data
load(".RData")
library(flextable)
library(dplyr)
# tbl_nation
#| label: load packages and data
load(".RData")
library(flextable)
library(dplyr)
table <- kable(mondays[, c("date", "value")],
col.names = c("Date", "Viral Ratio (log10 CPM)"),
digits = 3, caption = "Monday Sampling Results") %>%
kable_styling(bootstrap_options = c("striped", "hover")) %>%
add_header_above(c(" " = 1, "National Average" = 1))
library(kableExtra)
table <- kable(mondays[, c("date", "value")],
col.names = c("Date", "Viral Ratio (log10 CPM)"),
digits = 3, caption = "Monday Sampling Results") %>%
kable_styling(bootstrap_options = c("striped", "hover")) %>%
add_header_above(c(" " = 1, "National Average" = 1))
library(kableExtra)
table <- kable(mondays[, c("date", "value")],
col.names = c("Date", "Viral Ratio (log10 CPM)"),
digits = 3, caption = "Monday Sampling Results") %>%
kable_styling(bootstrap_options = c("striped", "hover")) %>%
add_header_above(c(" " = 1, "National Average" = 1))
install.packages(setdiff(pkgs, rownames(installed.packages())))
invisible(lapply(pkgs, FUN = library, character.only = TRUE))
df_nation <- read.table(file = "Belgium_export-nation.csv", sep = ";", dec = ".", header = T)
View(tbl_nation)
library(dplyr)
mondays <- Belgium_export_nation %>%
mutate(datetime = as.POSIXct(date)) %>%
filter(weekdays(datetime) == "Monday")
View(mondays)
library(knitr)
install.packages("kableExtra")
install.packages("kableExtra")
setwd("~/training-eu_wish-team_8")
library(dplyr)
library(knitr)
tbl_nation_df <- df_nation %>%
select(siteName, date, value_pmmv) %>%
arrange(desc(as.Date(date))) %>%
slice_head(n = 10)
kable(
tbl_nation_df,
col.names = c("WWTP / Site", "Sampling date", "Viral ratio (PMMoV)"),
digits = 2,
library(dplyr)
library(knitr)
View(Belgium_export_nation)
View(Belgium_export_nation)
# display msg
cat("- Success : tables saved \n")
View(mondays)
library(knitr)
install.packages("kableExtra")
install.packages("tidyverse")
install.packages("palmerpenguins")
setwd("~/WRC Unsewered")
Aim ----
#| generating wastewater reports
# NOTES:
#| git cheat: git status, git add -A, git commit -m "", git push, git pull, git restore
############################################################################### #
# Load packages ----
# select packages
pkgs <- c("dplyr", "ggplot2", "flextable", "quarto")
# Aim ----
#| generating wastewater reports
# NOTES:
#| git cheat: git status, git add -A, git commit -m "", git push, git pull, git restore
############################################################################### #
# Load packages ----
# select packages
pkgs <- c("dplyr", "ggplot2", "flextable", "quarto")
# install packages
install.packages(setdiff(pkgs, rownames(installed.packages())))
invisible(lapply(pkgs, FUN = library, character.only = TRUE))
# load epi assessment
main_text <- read.csv("epi_assessment_text.csv")
# Render weekly sub report ----
save.image(".RData")
# settings
output_name <- paste0("Report-", format(date_reporting, "%G-W%V"))
setwd("~/training-eu_wish-team_8")
############################################################################### #
# Aim ----
#| load, clean and save data
############################################################################### #
# Aim ----
#| load, clean and save data
# NOTES:
#| git cheat: git status, git add -A, git commit -m "", git push, git pull, git restore
#| list of things to do...
############################################################################### #
# Load packages ----
# select packages
pkgs <- c("dplyr", "tidyr", "zoo", "writexl", "flextable", "ggplot2", "quarto")
# install packages
install.packages(setdiff(pkgs, rownames(installed.packages())))
invisible(lapply(pkgs, FUN = library, character.only = TRUE))
# load data ----
# Belgian data are available here https://www.geo.be/catalog/details/9eec5acf-a2df-11ed-9952-186571a04de2?l=en
#| Metadata
#| siteName is the name of the treatment plant
#| collDTStart is the date of sampling
#| labName is the name of the lab analysing the sample
#| labProtocolID is the protocol used to analyse the dample
#| flowRate is the flow rate measured at the inlet of the treatment plant during sampling
#| popServ is the population covered by the treatment plant
#| measure is the target measured
#| value is the result
# sars-cov-2 data
df_sc <- read.csv("https://data.geo.be/ws/sciensano/wfs?SERVICE=WFS&REQUEST=GetFeature&VERSION=2.0.0&TYPENAMES=sciensano:wastewatertreatmentplantscovid&outputFormat=csv")
# pmmv data
df_pmmv <- read.csv("https://data.geo.be/ws/sciensano/wfs?SERVICE=WFS&REQUEST=GetFeature&VERSION=2.0.0&TYPENAMES=sciensano:wastewatertreatmentplantspmmv&outputFormat=csv")
# join both
df <- df_sc %>%
rbind(df_pmmv)
# clean data
df <- df %>%
select(siteName, collDTStart, labName, labProtocolID, flowRate, popServ, measure, value, quality) %>%
rename(date = collDTStart) %>%
mutate(date = as.Date(date))
# set and subset dates
date_reporting <- as.Date("2025-09-01", format = "%Y-%m-%d")
date_graph_start <- as.Date("2024-09-01", format = "%Y-%m-%d")
date_graph_end <- as.Date("2025-12-01", format = "%Y-%m-%d")
# subset sars and pmmv data based on labProtocolID used betwen date_start and date_end
# display existing labProtocolID
# unique(df$labProtocolID)
df <- df %>%
filter(labProtocolID %in%
c("SC_COV_4.1",
"UA_COV_4.0",
"SC_PMMV_2.1",
"UA_PMMV_2.0"))
# rename measures
# diplay existing measure
# unique(df$measure)
df[df$measure == "SARS-CoV-2 E gene", ]$measure <- "SARS"
df[df$measure == "SARS-CoV-2 nucleocapsid gene, allele 2", ]$measure <- "SARS"
df[df$measure == "Pepper mild mottle virus capsid protein gene region", ]$measure <- "PMMV"
# translate siteName to english
df[df$siteName == "Bruxelles-Sud", ]$siteName <- "Brussels-South"
df[df$siteName == "Bruxelles-Nord", ]$siteName <- "Brussels-North"
# apply LOQ provided by the lab
df[df$measure == "PMMV" & df$value < 250, ]$value <- NA
df[df$measure == "SARS" & df$value < 8, ]$value <- NA
# remove outliers
df[df$quality == "Quality concerns", ]$value <- NA
# normalization ----
# compute mean of replicated analysis of each measure
df <- df %>%
select(date, siteName, labName, flowRate, popServ, measure, value) %>%
group_by(date, siteName, labName, flowRate, popServ, measure) %>%
summarise(value = mean(value, na.rm = TRUE)) %>% ungroup()
# pivot
df <- df %>%
pivot_wider(names_from = measure, values_from = value)
# compute viral load (value_load), viral ratio (value_ratio)
df <- df %>%
pivot_longer(cols = SARS, names_to = "measure", values_to = "value") %>%
mutate(value_load = value*flowRate*24*1000000/popServ*100000,
value_pmmv = value/PMMV)
# save
df_site_raw <- df
# smoothening ----
# compute the linear extrapolation data
df <- df_site_raw %>%
group_by(siteName) %>%
complete(date = seq(min(date), max(date), "day")) %>%
mutate(value_avg14d_past = na.approx(value, maxgap = 14, na.rm = FALSE),
value_load_avg14d_past = na.approx(value_load, maxgap = 14, na.rm = FALSE),
value_pmmv_avg14d_past = na.approx(value_pmmv, maxgap = 14, na.rm = FALSE))
# compute moving average on past 14 days
df <- df %>%
group_by(siteName) %>%
mutate(across(value_avg14d_past:value_pmmv_avg14d_past,
~ rollmean(.x, k = 14, fill = NA, na.rm = TRUE, align = "right")))
# save
df_site <- df
# national level ----
## aggregation ----
# compute weighted mean with factor being the population served by each site
df <- df_site_raw %>%
select(date, popServ, value, value_load, value_pmmv) %>%
mutate(siteName = "Belgium") %>%
group_by(siteName, date) %>%
summarise(across(value:value_pmmv, ~ weighted.mean(.x, popServ, na.rm=TRUE))) %>% ungroup()
## smoothening ----
# linear extrapolation data
df <- df %>%
group_by(siteName) %>%
complete(date = seq(min(date), max(date), "day")) %>%
mutate(value_avg14d_past = na.approx(value, maxgap = 14, na.rm = FALSE),
value_load_avg14d_past = na.approx(value_load, maxgap = 14, na.rm = FALSE),
value_pmmv_avg14d_past = na.approx(value_pmmv, maxgap = 14, na.rm = FALSE))
# moving average on past 14 days
df <- df %>%
group_by(siteName) %>%
mutate(across(value_avg14d_past:value_pmmv_avg14d_past,
~ rollmean(.x, k = 14, fill = NA, na.rm = TRUE, align = "right")))
# save
df_nation <- df
# export data ----
# create folder if not existing
dir.create("./data", showWarnings = F)
# export as csv
write.table(df_site_raw, file = "./data/Belgium_export-site_raw.csv", sep = ";", dec = ".",
col.names = TRUE, row.names = FALSE)
write.table(df_nation, file = "./data/Belgium_export-site.csv", sep = ";", dec = ".",
col.names = TRUE, row.names = FALSE)
write.table(df_nation, file = "./data/Belgium_export-nation.csv", sep = ";", dec = ".",
col.names = TRUE, row.names = FALSE)
# export as xls
write_xlsx(
list(site_raw = df_site_raw, site = df_site, nation = df_nation),
path = "./data/Belgium_export.xlsx"
)
# export as rds
saveRDS(list(df_site_raw, df_site, df_nation),
file = "./data/Belgium_export.rds")
# display msg
cat("- Success : data prep \n")
pkgs <- c("dplyr", "tidyr", "zoo", "writexl", "flextable", "ggplot2", "quarto")
# install packages
install.packages(setdiff(pkgs, rownames(installed.packages())))
invisible(lapply(pkgs, FUN = library, character.only = TRUE))
# load data ----
# Belgian data are available here https://www.geo.be/catalog/details/9eec5acf-a2df-11ed-9952-186571a04de2?l=en
#| Metadata
#| siteName is the name of the treatment plant
#| collDTStart is the date of sampling
#| labName is the name of the lab analysing the sample
#| labProtocolID is the protocol used to analyse the dample
#| flowRate is the flow rate measured at the inlet of the treatment plant during sampling
#| popServ is the population covered by the treatment plant
#| measure is the target measured
#| value is the result
# sars-cov-2 data
df_sc <- read.csv("https://data.geo.be/ws/sciensano/wfs?SERVICE=WFS&REQUEST=GetFeature&VERSION=2.0.0&TYPENAMES=sciensano:wastewatertreatmentplantscovid&outputFormat=csv")
# pmmv data
df_pmmv <- read.csv("https://data.geo.be/ws/sciensano/wfs?SERVICE=WFS&REQUEST=GetFeature&VERSION=2.0.0&TYPENAMES=sciensano:wastewatertreatmentplantspmmv&outputFormat=csv")
# join both
df <- df_sc %>%
rbind(df_pmmv)
# clean data
df <- df %>%
select(siteName, collDTStart, labName, labProtocolID, flowRate, popServ, measure, value, quality) %>%
rename(date = collDTStart) %>%
mutate(date = as.Date(date))
# set and subset dates
date_reporting <- as.Date("2025-09-01", format = "%Y-%m-%d")
date_graph_start <- as.Date("2024-09-01", format = "%Y-%m-%d")
date_graph_end <- as.Date("2025-12-01", format = "%Y-%m-%d")
# subset sars and pmmv data based on labProtocolID used betwen date_start and date_end
# display existing labProtocolID
# unique(df$labProtocolID)
df <- df %>%
filter(labProtocolID %in%
c("SC_COV_4.1",
"UA_COV_4.0",
"SC_PMMV_2.1",
"UA_PMMV_2.0"))
# rename measures
# diplay existing measure
# unique(df$measure)
df[df$measure == "SARS-CoV-2 E gene", ]$measure <- "SARS"
df[df$measure == "SARS-CoV-2 nucleocapsid gene, allele 2", ]$measure <- "SARS"
df[df$measure == "Pepper mild mottle virus capsid protein gene region", ]$measure <- "PMMV"
# translate siteName to english
df[df$siteName == "Bruxelles-Sud", ]$siteName <- "Brussels-South"
df[df$siteName == "Bruxelles-Nord", ]$siteName <- "Brussels-North"
# apply LOQ provided by the lab
df[df$measure == "PMMV" & df$value < 250, ]$value <- NA
df[df$measure == "SARS" & df$value < 8, ]$value <- NA
# remove outliers
df[df$quality == "Quality concerns", ]$value <- NA
# normalization ----
# compute mean of replicated analysis of each measure
df <- df %>%
select(date, siteName, labName, flowRate, popServ, measure, value) %>%
group_by(date, siteName, labName, flowRate, popServ, measure) %>%
summarise(value = mean(value, na.rm = TRUE)) %>% ungroup()
# pivot
df <- df %>%
pivot_wider(names_from = measure, values_from = value)
# compute viral load (value_load), viral ratio (value_ratio)
df <- df %>%
pivot_longer(cols = SARS, names_to = "measure", values_to = "value") %>%
mutate(value_load = value*flowRate*24*1000000/popServ*100000,
value_pmmv = value/PMMV)
# save
df_site_raw <- df
# smoothening ----
# compute the linear extrapolation data
df <- df_site_raw %>%
group_by(siteName) %>%
complete(date = seq(min(date), max(date), "day")) %>%
mutate(value_avg14d_past = na.approx(value, maxgap = 14, na.rm = FALSE),
value_load_avg14d_past = na.approx(value_load, maxgap = 14, na.rm = FALSE),
value_pmmv_avg14d_past = na.approx(value_pmmv, maxgap = 14, na.rm = FALSE))
# compute moving average on past 14 days
df <- df %>%
group_by(siteName) %>%
mutate(across(value_avg14d_past:value_pmmv_avg14d_past,
~ rollmean(.x, k = 14, fill = NA, na.rm = TRUE, align = "right")))
# save
df_site <- df
# national level ----
## aggregation ----
# compute weighted mean with factor being the population served by each site
df <- df_site_raw %>%
select(date, popServ, value, value_load, value_pmmv) %>%
mutate(siteName = "Belgium") %>%
group_by(siteName, date) %>%
summarise(across(value:value_pmmv, ~ weighted.mean(.x, popServ, na.rm=TRUE))) %>% ungroup()
## smoothening ----
# linear extrapolation data
df <- df %>%
group_by(siteName) %>%
complete(date = seq(min(date), max(date), "day")) %>%
mutate(value_avg14d_past = na.approx(value, maxgap = 14, na.rm = FALSE),
value_load_avg14d_past = na.approx(value_load, maxgap = 14, na.rm = FALSE),
value_pmmv_avg14d_past = na.approx(value_pmmv, maxgap = 14, na.rm = FALSE))
# moving average on past 14 days
df <- df %>%
group_by(siteName) %>%
mutate(across(value_avg14d_past:value_pmmv_avg14d_past,
~ rollmean(.x, k = 14, fill = NA, na.rm = TRUE, align = "right")))
# save
df_nation <- df
# export data ----
# create folder if not existing
dir.create("./data", showWarnings = F)
# export as csv
write.table(df_site_raw, file = "./data/Belgium_export-site_raw.csv", sep = ";", dec = ".",
col.names = TRUE, row.names = FALSE)
write.table(df_nation, file = "./data/Belgium_export-site.csv", sep = ";", dec = ".",
col.names = TRUE, row.names = FALSE)
write.table(df_nation, file = "./data/Belgium_export-nation.csv", sep = ";", dec = ".",
col.names = TRUE, row.names = FALSE)
# export as xls
write_xlsx(
list(site_raw = df_site_raw, site = df_site, nation = df_nation),
path = "./data/Belgium_export.xlsx"
)
# export as rds
saveRDS(list(df_site_raw, df_site, df_nation),
file = "./data/Belgium_export.rds")
# display msg
cat("- Success : data prep \n")
pkgs <- c("dplyr", "ggplot2", "flextable", "quarto")
# install packages
install.packages(setdiff(pkgs, rownames(installed.packages())))
invisible(lapply(pkgs, FUN = library, character.only = TRUE))
# load epi assessment
main_text <- read.csv("epi_assessment_text.csv")
# Render weekly sub report ----
save.image(".RData")
# settings
output_name <- paste0("Report-", format(date_reporting, "%G-W%V"))
format_output <- c("html")
# format_output <- c("html","docx")
quarto_render(input = "04_quarto.qmd",
output_file = output_name,
output_format = format_output)
cat("- Success : quarto render \n")
# Load packages ----
# select packages
pkgs <- c("dplyr", "ggplot2", "flextable", "quarto")
# install packages
install.packages(setdiff(pkgs, rownames(installed.packages())))
invisible(lapply(pkgs, FUN = library, character.only = TRUE))
# load epi assessment
main_text <- read.csv("epi_assessment_text.csv")
# Render weekly sub report ----
save.image(".RData")
# settings
output_name <- paste0("Report-", format(date_reporting, "%G-W%V"))
format_output <- c("html")
# format_output <- c("html","docx")
quarto_render(input = "04_quarto.qmd",
output_file = output_name,
output_format = format_output)
cat("- Success : quarto render \n")
| generating wastewater reports
pkgs <- c("dplyr", "ggplot2", "flextable", "quarto")
# install packages
install.packages(setdiff(pkgs, rownames(installed.packages())))
invisible(lapply(pkgs, FUN = library, character.only = TRUE))
# load epi assessment
main_text <- read.csv("epi_assessment_text.csv")
# Render weekly sub report ----
save.image(".RData")
# settings
output_name <- paste0("Report-", format(date_reporting, "%G-W%V"))
format_output <- c("html")
# format_output <- c("html","docx")
quarto_render(input = "04_quarto.qmd",
output_file = output_name,
output_format = format_output)
cat("- Success : quarto render \n")
load, clean and save data
pkgs <- c("dplyr", "ggplot2", "flextable", "quarto")
# install packages
install.packages(setdiff(pkgs, rownames(installed.packages())))
invisible(lapply(pkgs, FUN = library, character.only = TRUE))
# load epi assessment
main_text <- read.csv("epi_assessment_text.csv")
# Render weekly sub report ----
save.image(".RData")
# settings
output_name <- paste0("Report-", format(date_reporting, "%G-W%V"))
format_output <- c("html")
# format_output <- c("html","docx")
quarto_render(input = "04_quarto.qmd",
output_file = output_name,
output_format = format_output)
cat("- Success : quarto render \n")
pkgs <- c("dplyr", "tidyr", "zoo", "writexl", "ggplot2")
# install packages
install.packages(setdiff(pkgs, rownames(installed.packages())))
invisible(lapply(pkgs, FUN = library, character.only = TRUE))
# load data ----
# Belgian data are available here https://www.geo.be/catalog/details/9eec5acf-a2df-11ed-9952-186571a04de2?l=en
#| Metadata
#| siteName is the name of the treatment plant
#| collDTStart is the date of sampling
#| labName is the name of the lab analysing the sample
#| labProtocolID is the protocol used to analyse the dample
#| flowRate is the flow rate measured at the inlet of the treatment plant during sampling
#| popServ is the population covered by the treatment plant
#| measure is the target measured
#| value is the result
# sars-cov-2 data
df_sc <- read.csv("https://data.geo.be/ws/sciensano/wfs?SERVICE=WFS&REQUEST=GetFeature&VERSION=2.0.0&TYPENAMES=sciensano:wastewatertreatmentplantscovid&outputFormat=csv")
# pmmv data
df_pmmv <- read.csv("https://data.geo.be/ws/sciensano/wfs?SERVICE=WFS&REQUEST=GetFeature&VERSION=2.0.0&TYPENAMES=sciensano:wastewatertreatmentplantspmmv&outputFormat=csv")
# join both
df <- df_sc %>%
rbind(df_pmmv)
# clean data
df <- df %>%
select(siteName, collDTStart, labName, labProtocolID, flowRate, popServ, measure, value)
# format date
df$date <- as.Date(df$date)
